# 16. Атомарность
Один из хороших способов правильно организовать программирование с параллелизмом и состоянием -- это использовать атомарные операции. Операция является атомарной, если мы не можем наблюдать какие-то промежуточные состояния обрабатываемых ей данных. Атомарная операция сразу "прыгает" непосредственно от начального состояния к конечному результату.

Упоминавшаяся проблема race conditions связана с тем, что нити, выполняющие некоторый набор действий над одной общей ячейкой памяти, начинают перебивать работу других нитей, выполняющих аналогичные действия. В результате значение этой ячейки меняется непредсказуемо: одна нить обрабатывает ранее считанное значение, и ещё не записала свой результат обратно, а в это время влезла другая нить и тоже изменила значение на своё. Один из способов борьбы с race conditions -- это организация так называемого потоково-безопасной (thread-safe) работы программы. Программисту предоставляется механизм атомарного выполнения: набор действий над общей ячейкой объявляется некоторой нитью атомарным, и пока он полностью не закончится, никакая другая нить не сможет работать с этой ячекой.

С помощью атомарных операций мы можем решить вышеприведённую проблему с неверным итоговым изменением переменной "a" в нескольких нитях. Идея заключается в том, чтобы обеспечить такой режим работы, когда тело каждой нити будет атомарным. Для этого нам нужен механизм построения атомарных операций.

Однако, атомарность и thread-safe в общем случае не гарантируют недетерминизма.

thread A
начало атомарной операции
y = 0
x = y
конец атомарной операции
print x

thread B
начало атомарной операции
y = 1
x = y
конец атомарной операции
print x
Теперь каждая из операций будет выполняться в своём кванте времени, без перебивки другими, однако итоговый результат всё равно будет непредсказуем (0 1 или 1 0).

Правильная детерминированная модель:

thread A
x = 0
запуск thread B
начало атомарной операции
x = x + 1
конец атомарной операции
ожидание окончания работы thread B
print x

thread B
начало атомарной операции
x = x + 2
конец атомарной операции
завершиться
В результате всегда будет выводиться 3.
